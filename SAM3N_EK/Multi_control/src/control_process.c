
#include "control_process.h"


const double force_2_voltage= -0.10438413361169;
const double voltage_2_dc=20;
//const double lvl_slope=-1.42857;
const double lvl_slope=-0.014287;

#ifdef MPC_GN_CONTROL


const double n_invH_Phi_F[6]={0.190745145366670,-0.231289109453906,0.0112044196859474,-0.00359114633758409,-0.000119127355691616,-0.0786417131902683};
	
	void mpc_gn_control(state_space *ss_actual, state_space *ss_ant, double *ant_FC){
		double su;
		double deltau;
		
		deltau=(n_invH_Phi_F[0]*((ss_actual->x2_x1)-(ss_ant->x2_x1)))+(n_invH_Phi_F[1]*((ss_actual->dx2)-(ss_ant->dx2)))
		+(n_invH_Phi_F[2]*((ss_actual->x1_Zr)-(ss_ant->x1_Zr)))+(n_invH_Phi_F[3]*((ss_actual->dx1)-(ss_ant->dx1)))
		+(n_invH_Phi_F[4]*(((ss_actual->x2_x1)+(ss_actual->x1_Zr))))+(n_invH_Phi_F[5]*(10*(ss_actual->dx2)));
		

		
		su=*ant_FC-deltau*400;
		
		//if (su>=35)
		//{
			//su=35;
			//
			//}else if( su<=-35){
			//su=-35;
			//
		//}

		*ant_FC=su;
	}

#endif

#ifdef MPC_MP_CONTROL


const double n_mpt_matrix[4]={-0.0069420807, -0.0083943797, 0.0017057322, 0.000001481};


void mpc_mp_control(state_space *ss_actual, state_space *ss_ant, double *ant_FC)
{
	double su;
	double U;
	
	
	

	
	U=(n_mpt_matrix[0]*(ss_actual->x2_x1))+(n_mpt_matrix[1]*(ss_actual->dx2))+(n_mpt_matrix[2]*(ss_actual->x1_Zr))+(n_mpt_matrix[3]*(ss_actual->dx1));
	
	su=-U*2000000;
	
	//if (su>=35)
	//{
		//su=35;
		//
		//}else if( su<=-35){
		//su=-35;
		//
	//}

	*ant_FC=su;
}

#endif

#ifdef MPC_RN_CONTROL

const double xminIn[5]={-0.0227338691009831, -0.0190784232488053, -0.00953495813852918, -0.468136377849448, -12.753829343276};
const double xmaxIn[5]={0.0192633528982328, 0.0225156280744467, 0.0103351150775825, 0.466574262607596, 19.979736328125};
//const double xminOut=-1;
//const double xmaxOut=1;		
//const double yminIn=-1;
//const double ymaxIn=1;
//const double yminOut=-22.651679254795;
//const double ymaxOut=19.3517999450096;
//const double xmaxOut=1;
const double IW[30][5]={{2.30887946325958,-0.667188053359432,4.35340640297970,-1.12559673159000,0.823401766099720},{0.341019583472759,0.171148559070155,-0.0474150120386576,-0.0927709916607135,0.107338117385728},{0.240853593519204,1.10302552125391,-1.61829046353772,-1.43467064968501,0.889196139147698},{-0.916031522323723,-1.75258686459332,0.662186896433835,0.150265848626123,-1.54533103350843},{1.93604560018987,-1.85282785038981,-1.23844115792987,-2.51565950581659,-0.488916310481775},{-0.110294769724122,0.718135219626925,-0.0748884068610386,1.84701077234009,3.80263663011817},{-0.127044976627082,2.48732531495907,2.83717348240766,0.934387461034820,-5.69555483443052},{19.3720444826476,-20.2246460263103,-6.26919549472421,-5.59170853335094,3.31070340187929},{1.11760927766725,0.878591092861851,-0.0667158866863368,-0.130556455236936,0.151061560924329},{-1.31703591473119,1.93219845842558,2.37199192665985,-1.04733356352318,-1.94475701654461},{-1.59897792182204,1.58138909045666,-0.407643183162130,-0.0234524296978578,0.728458414044534},{-0.113988443290684,-0.444045777280903,1.21288205157286,-1.97216653697237,-0.646632984389810},{2.80931178715353,1.42544101580748,1.60016224487938,1.68342734768211,2.94509641625071},{1.25241256221392,0.458291791188174,0.887118378973665,1.19786381448826,0.496899161353441},{-1.21058437340452,-1.53420810644987,0.256181368435052,0.0581642484187066,-0.597710612263069},{1.86949125361178,-1.76513193669040,0.697424334787322,0.825671394733043,1.88906463619482},{-5.06425592462352,2.22313789266056,12.0807067019196,-41.8505815852396,-5.67220201699670},{-1.84800631218064,1.98789991500531,2.97300450452398,-1.11239491985360,-6.82056430803778},{-0.412135252471585,-0.557908325591464,-0.0406919192473182,-0.0795881691066609,0.0920930288772009},{-1.74622807763826,-0.0563493333323835,1.53855975208091,0.205030581523421,-1.62415512870828},{-0.295388251364280,-0.383103620647642,0.0694296939132594,0.0157591202619346,-0.161998351654996},{-1.47404930844706,0.997058799539720,1.85996335739405,0.473652048117082,0.118967685306203},{-1.55285919137325,-1.00769400662873,-1.18639451789668,1.11714727688293,-0.422905164371805},{-0.125176135450307,2.07360817922631,-0.708158933501207,-0.387119093405214,-1.66829773161925},{-0.146924269280852,0.749424639012572,3.72937861111840,1.12457050542426,-2.37815528047770},{0.0444732765254410,-0.982583365532565,-0.421894566897284,-1.13331439727742,2.46499774574083},{-2.07314544466319,-0.136009601262402,0.411770949306694,0.902488045439300,-0.265386824088853},{-0.292020895340020,1.57154372316256,2.55585566422994,-3.64446769218832,-4.38662424970010},{-0.435782621744754,1.36089974467851,2.65111118465687,4.34984647276256,-2.02851617810972},{2.15374920819315,-0.131747762380157,-1.25863944397464,-1.79616370587126,-2.22141790688389}};
const double b1[30]={-4.19603795513308 , 1.09003127072578 , 1.80699404802729 , 1.67190894670781 , -2.64224374539711 , 2.44568669672535 , -4.50414677995182 , -17.3860098821799 , -1.35531500627219 , -1.39016908805334 , 1.47658718749207 , 0.0000398616876483072 , 0.574171756701671 , 1.13309433937457 , 0.573524907395911 , 0.301993624526005 , -4.29126362210558 , -2.66981842610753 , -0.110011304152590 , -0.888487439333561 , -0.322307761686691 , -0.655239095575873 , -1.44190867457456 , 1.39374828265494 , -2.02201342154831 , 0.375014615920960 , -0.0513689715319280 , 0.669306182363004 , -1.61719693972948 , 3.16385138764613};
const double LW[30]={-0.000000004855403 , 2.59143014433165 , -0.0000001267364975 , 0.0145778524667989 , 0.000000056570349 , 0.0000001350254848 , 0.000000046892320149 , -0.00000000162176677815122 , 1.23748201782468 , 0.0000000039024897617 , 0.000000027097780789472 , -0.0000000130433989810016 , 0.00000000212940666982440 , -0.000000262086289150992 , 0.121369006639265 , -0.0000000441857787266887 , -0.000000000317654775024413 , -0.00000000397054768293086 , 3.16340265543988 , 0.0000000855906321475598 , 2.80430032886151 , -0.0000000271729774768756 , -0.0000000114655507333289 , 0.000000296238041626062 , 0.00000000507419614549618 , -0.000000193390768624848 , 0.00000107720822267909 , 0.00000000243962541293380 , 0.00000000114583574343092 , 0.00000000887853423150447};
const double b2=0.156679194055084;
const int n_neuron=30;
const int n_inputs=5;

void mpc_rn_control(state_space *ss_actual, state_space *ss_ant, double *ant_FC)
{
	double su=0;
	double z[5];
	double aux[30]={0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};


	
//X=[X' dz];
z[0]=(2)*(ss_actual->x2_x1-xminIn[0])/(xmaxIn[0]-xminIn[0])-1;
z[1]=(2)*(ss_actual->dx2-xminIn[1])/(xmaxIn[1]-xminIn[1])-1;
z[2]=(2)*(ss_actual->x1_Zr-xminIn[2])/(xmaxIn[2]-xminIn[2])-1;
z[3]=(2)*(ss_actual->dx1-xminIn[3])/(xmaxIn[3]-xminIn[3])-1;
z[4]=(2)*(ss_actual->dZr-xminIn[4])/(xmaxIn[4]-xminIn[4])-1;

//
//X=(ymaxIn-yminIn).*(X-xminIn)./(xmaxIn-xminIn) + yminIn;

for (int i=0;i<n_neuron;i++)
{
	for (int j=0;j<n_inputs;j++)
	{
		aux[i]+=z[j]*IW[i][j];
	}
}

for (int i=0;i<n_neuron;i++)
{
	aux[i]+=b1[i];
}

for (int i=0;i<n_neuron;i++)
{
	aux[i]=tangh(aux[i]);
}

for (int i=0;i<n_neuron;i++)
{
	su+=aux[i]*LW[i];
}

su+=b2;

su=(42.0035)*(su+1)/(2) -22.6517;

//if (su>=35)
//{
	//su=35;
	//
	//}else if( su<=-35){
	//su=-35;
	//
//}

*ant_FC=-su*10;

}

#endif

#ifdef MPC_SS_CONTROL


const double n_ss[4]={23.33139806, 43.10776718, -100.56171,4.242556725};

void mpc_ss_control(state_space *ss_actual, state_space *ss_ant, double *ant_FC){
	double su;
	
	
	su=((n_ss[0]*ss_actual->x2_x1)+(n_ss[1]*ss_actual->dx2)+(n_ss[2]*ss_actual->x1_Zr)+(n_ss[3]*ss_actual->dx1));
	
	
	//if (su>=35)
	//{
		//su=35;
		//
		//}else if( su<=-35){
		//su=-35;
		//
	//}

	*ant_FC=su*100;
}

#endif


//double exp(double x){
	//double s;
	//double term;
	//double r;
	//int n;
	//
	//if (x<0){
		//x=-x;
		//s = 1;
		//term = 1;
		//n = 0;
		//r = 0;
		//while (r != s){
			//r = s;
			//n = n + 1;
			//term = (x/n)*term;
			//s = s + term;
						//
		//}
		//s=1/s;
		//}else{
		//s = 1;
		//term = 1;
		//n = 0;
		//r = 0;
		//while (r != s){
			//r = s;
			//n = n + 1;
			//term = (x/n)*term;
			//s = s + term;
			//
		//}
	//}
	//
	//return s;
//}

double tangh(double x){
	double aux=0;
	if (x>4.6)
	{
		aux=1;
	}else if (x<-4.6)
	{
		aux=-1;
		}else {
		//aux=aux+(2/(exp(-2*x)+1))-1;
		aux=aux+x;
	}
	
	return aux;
}

int force2dutycicle(double fc){
	int dc;
	
	//Acondicionamiento de nivel
	
	dc=(int)(lvl_slope*fc+50);
	
	if (dc>100)
	{
		dc=100;
		return	dc;
		
	}else if (dc<0)
	{
		dc=0;
		return	dc;
	}else{
		
		return dc;
	}
	
	
	
	
	
	
}


